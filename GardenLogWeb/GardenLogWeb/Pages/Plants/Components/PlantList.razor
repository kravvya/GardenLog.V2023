@inject ILogger<PlantList> _logger;
@inject IVerifyService _verifyService;
@inject IPlantService _plantService;
@inject IGardenLogToastService _toastService;
@inject NavigationManager _navigationManager;

<div class="row">
    <div id="plant-filter" class="col-md-2 d-md-block collapse">
        <h3 class="text-uppercase text-primary d-none d-md-block">Filters</h3>
        <EditForm Model=@_filter>
            <div class="d-flex flex-wrap">
                <div id="lifecycle-filter" class="my-3 mx-1">
                    <h5 class="text-uppercase text-primary">Lifecylce</h5>
                    @foreach (var life in _filter.PlantLifecycleEnums)
                    {
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" type="checkbox" @bind-Value="life.IsSelected" id="@life.EnumItem.Key" />
                            <label class="form-check-label" for="@life.EnumItem.Key">
                                @life.EnumItem.Value
                            </label>
                        </div>
                    }
                    <a id="clear-lifecycle" onclick=@(() => Clear(_filter.PlantLifecycleEnums))>Clear</a>
                </div>
                <div id="type-filter" class="my-3 mx-1">
                    <h5 class="text-uppercase text-primary">Type</h5>
                    @foreach (var type in _filter.PlantTypeEnums)
                    {
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" type="checkbox" @bind-Value="type.IsSelected" id="@type.EnumItem.Key" />
                            <label class="form-check-label" for="@type.EnumItem.Key">
                                @type.EnumItem.Value
                            </label>
                        </div>
                    }
                    <a  id="clear-type" onclick=@(() => Clear(_filter.PlantTypeEnums))>Clear</a>
                </div>
                <div id="light-filter" class="my-3 mx-1">
                    <h5 class="text-uppercase text-primary">Conditions</h5>
                    @foreach (var grow in _filter.LightRequirementEnums)
                    {
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" type="checkbox" @bind-Value="grow.IsSelected" id="@grow.EnumItem.Key" />
                            <label class="form-check-label" for="@grow.EnumItem.Key">
                                @grow.EnumItem.Value
                            </label>
                        </div>
                    }
                    <a id="clear-light" onclick=@(() => Clear(_filter.MoistureRequirementEnums))>Clear</a>
                </div>
                <div id="light-filter" class="my-3 mx-1">
                    <h5 class="text-uppercase text-primary">Watering</h5>
                    @foreach (var water in _filter.MoistureRequirementEnums)
                    {
                        <div class="form-check">
                            <InputCheckbox class="form-check-input" type="checkbox" @bind-Value="water.IsSelected" id="@water.EnumItem.Key" />
                            <label class="form-check-label" for="@water.EnumItem.Key">
                                @water.EnumItem.Value
                            </label>
                        </div>
                    }
                    <a id="clear-light" onclick=@(() => Clear(_filter.LightRequirementEnums))>Clear</a>
                </div>
            </div>
        </EditForm>
    </div>

    <div id="plants" class="col-md-9">
        <section>
            <article id="plantList">

                <div id="icon-legend" class="d-none d-lg-block">
                    <div class="d-flex flex-row text-center">
                        <div class="p-2"><img src="./images/FullSun.png" alt="Full Sun" title="Full Sun" class="img-fluid" /><br />Full Sun</div>
                        <div class="p-2"><img src="./images/PartShade.png" alt="Part Shade" title="Part Shade" class="img-fluid" /><br />Part Shade</div>
                        <div class="p-2"><img src="./images/FullShade.png" alt="Full Shade" title="Full Shade" class="img-fluid" /><br />Full Shade</div>
                        <div class="p-2"><img src="./images/Vegetable.png" alt="Vegetable" title="Vegetable" class="img-fluid" /><br />Vegetable</div>
                        <div class="p-2"><img src="./images/Flower.png" alt="Flower" title="Flower" class="img-fluid" /><br />Flower</div>
                        <div class="p-2"><img src="./images/Herb.png" alt="Herb" title="Herb" class="img-fluid" /><br />Herb</div>
                        <div class="p-2"><img src="./images/Berry.png" alt="Berry" title="Berry" class="img-fluid" /><br />Berry</div>
                        <div class="pt-3 ps-2"><img src="./images/Perennial.png" alt="Perennial" title="Perennial" class="img-fluid"><br />Perennial</div>
                        <div class="pt-3 ps-2"><img src="./images/Biennial.png" alt="Biennial" title="Biennial" class="img-fluid"><br />Biennial</div>
                        <div class="pt-3 ps-2"><img src="./images/Annual.png" alt="Annual" title="Annual" class="img-fluid"><br />Annual</div>
                    </div>
                </div>

                <div id="toggle-filter" class="d-md-none py-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#plant-filter" aria-expanded="false" aria-controls="plant-filter">Filters</button>
                </div>

                @if (_plants == null)
                {
                    <p><em>Empty</em></p>
                }
                else
                {
                    <div class="table-responsive d-none d-sm-block">
                        <table class="table table-borderless align-middle text-center ">
                            <thead class="table-primary" style="border-width: 2px;">
                                <tr>
                                    <th scope="col">Name</th>
                                    <th scope="col">Grow Conditions</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Notes</th>
                                    <th><div @onclick=@CreatePlant class="btn d-inline-block  btn-primary"><span class="bi bi-plus-lg">Add</span></div></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var plant in _plants.OrderBy(p => p.PlantName))
                                {
                                    if (IsVisible(plant))
                                    {
                                        <tr style="border-width: 2px; border-color: @(plant.Color);" @key="plant.PlantId">
                                            <td class="col-2 text-start "><a @onclick=@(() => ViewPlant(plant)) class="text-dark"><span class="lead fw-bold">@plant.PlantName</span></a></td>
                                            <td class="col-1"><img src="./images/@(plant.LightRequirement).png" alt="plant.LightRequirement" title="plant.LightRequirement" class="img-fluid" /></td>
                                            <td class="col-1"><img src="./images/@(plant.Type).png" alt="@plant.Type" title="@plant.Type" class="img-fluid" /><img src="./images/@(plant.Lifecycle).png" alt="@plant.Lifecycle" title="@plant.Lifecycle" class="img-fluid"></td>
                                            <td class="col-2 text-start">
                                                <span class="fw-bold" >Moisture:</span> <br /> @GetDescription(_filter.MoistureRequirementEnums, plant.MoistureRequirement) <br />
                                                <span class="fw-bold" >Varieties:</span> @plant.VarietyCount<br />
                                                <span class="fw-bold" >Instructions: </span>@plant.GrowCount
                                            </td>
                                            <td class="col-3">
                                                <button type="button" class="btn btn-outline-primary" title="Edit Plant" onclick="@(() => EditPlant(plant))"><span class="bi bi-pencil">&nbsp;</span></button>
                                                <button type="button" class="btn btn-outline-primary" title="Add Variety" onclick="@(() => CreatePlantVariety(plant))"><span class="bi bi-journal-richtext">&nbsp;</span></button>
                                                <button type="button" class="btn btn-outline-primary" title="Add Growing Instruction" onclick="@(() => CreatePlantGrowInstructions(plant))"><span class="bi bi-journals">&nbsp;</span></button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tfoot class="table-primary" style="border-width: 2px;">
                                <tr>
                                    <td />
                                    <td />
                                    <td />
                                    <td />
                                    <td> <div @onclick=@CreatePlant class="btn d-inline-block  btn-primary"><span class="bi bi-plus-lg">Add</span></div></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="row d-block d-sm-none">
                        @foreach (var plant in _plants.OrderBy(p => p.PlantName))
                        {
                            if (IsVisible(plant))
                            {
                                <div class="col-sm-6">
                                    <div class="card bg-light mb-2" style="border-color:  @(plant.Color);">
                                        <div class="card-header" style="background-color:  @(plant.Color);">
                                            <a @onclick=@(() => ViewPlant(plant)) class="text-dark"><span class="lead fw-bold">@plant.PlantName</span></a>
                                        </div>
                                        <div class="card-body row">
                                            <div class="col">
                                                <span class="fw-bold" >Moisture:</span> <br /> @GetDescription(_filter.MoistureRequirementEnums, plant.MoistureRequirement) <br />
                                                <span class="fw-bold" >Varieties:</span> @plant.VarietyCount<br />
                                                <span class="fw-bold" >Instructions: </span>@plant.GrowCount
                                            </div>

                                            <div class="col">
                                                <img src="./images/@(plant.LightRequirement).png" alt="plant.LightRequirement" title="plant.LightRequirement" class="img-fluid" />
                                                <img src="./images/@(plant.Type).png" alt="@plant.Type" title="@plant.Type" class="img-fluid" />
                                                <img src="./images/@(plant.Lifecycle).png" alt="@plant.Lifecycle" title="@plant.Lifecycle" class="img-fluid">
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                                <button type="button" class="btn btn-outline-primary" title="Edit Plant" onclick="@(() => EditPlant(plant))"><span class="bi bi-pencil">&nbsp;</span></button>
                                                <button type="button" class="btn btn-outline-primary" title="Add Variety" onclick="@(() => CreatePlantVariety(plant))"><span class="bi bi-journal-richtext">&nbsp;</span></button>
                                                <button type="button" class="btn btn-outline-primary" title="Add Growing Instruction" onclick="@(() => CreatePlantGrowInstructions(plant))"><span class="bi bi-journals">&nbsp;</span></button>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }

            </article>
        </section>
    </div>
</div>
@code {

    public IList<PlantModel> _plants { get; set; }
    public PlantFilter _filter { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _filter = new PlantFilter(_verifyService);

        _plants = await _plantService.GetPlants(false);

        StateHasChanged();
    }

    public bool IsVisible(PlantModel plant)
    {
        if (_filter.LightRequirementEnums.Exists(cb => cb.IsSelected) && !_filter.LightRequirementEnums.Exists(cb => cb.IsSelected && cb.EnumItem.Key.Equals(plant.LightRequirement)))
            return false;

        if (_filter.PlantTypeEnums.Exists(cb => cb.IsSelected) && !_filter.PlantTypeEnums.Exists(cb => cb.IsSelected && cb.EnumItem.Key.Equals(plant.Type)))
            return false;

        if (_filter.PlantLifecycleEnums.Exists(cb => cb.IsSelected) && !_filter.PlantLifecycleEnums.Exists(cb => cb.IsSelected && cb.EnumItem.Key.Equals(plant.Lifecycle)))
            return false;

        if (_filter.MoistureRequirementEnums.Exists(cb => cb.IsSelected) && !_filter.MoistureRequirementEnums.Exists(cb => cb.IsSelected && cb.EnumItem.Key.Equals(plant.MoistureRequirement)))
            return false;

        return true;
    }

    public string GetDescription(List<CheckableEnum> list, string code)
    {
        return list.FirstOrDefault(c => c.EnumItem.Key.Equals(code))?.EnumItem.Value;
    }

    public void Clear(List<CheckableEnum> options)
    {
        options.ForEach(o => o.IsSelected = false);
    }

    protected void CreatePlant()
    {
        _navigationManager.NavigateToCreatePlant();
    }

    public void EditPlant(PlantModel plant)
    {
        _navigationManager.NavigateToEditPlant(plant.PlantId);
    }

    public void CreatePlantVariety(PlantModel plant)
    {
        _navigationManager.NavigateToCreatePlantVariety(plant.PlantId);
    }

    public void CreatePlantGrowInstructions(PlantModel plant)
    {
        _navigationManager.NavigateToCreatePlantGrowInstruction(plant.PlantId);
    }

    protected void ViewPlant(PlantModel plant)
    {
        _navigationManager.NavigateToViewPlant(plant.PlantId);
    }

}
