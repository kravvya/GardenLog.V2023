@inject IHarvestCycleService _harvestService;
@inject IGardenService _gardenService;

<div>
    @if (_plants == null || _plants.Count == 0)
    {
        <p><em>Empty</em></p>
    }

    else
    {
        <div class="row flex-nowrap" id="calendar-header">
            <div class="col-2">&nbsp;</div>

            <div class="col-10">
                <div class="row flex-nowrap months-header g-0 text-center fw-semibold">
                    <div class="col month pe-1"><small>Jan</small></div>
                    <div class="col month pe-1"><small>Feb</small></div>
                    <div class="col month pe-1"><small>Mar</small></div>
                    <div class="col month pe-1"><small>Apr</small></div>
                    <div class="col month pe-1"><small>May</small></div>
                    <div class="col month pe-1"><small>Jun</small></div>
                    <div class="col month pe-1"><small>Jul</small></div>
                    <div class="col month pe-1"><small>Aug</small></div>
                    <div class="col month pe-1"><small>Sep</small></div>
                    <div class="col month pe-1"><small>Oct</small></div>
                    <div class="col month pe-1"><small>Nov</small></div>
                    <div class="col month pe-1"><small>Dec</small></div>
                </div>
            </div>
        </div>

        @foreach (var plant in _plants)
        {
            <div class="row flex-nowrap plant-schedule border-bottom border-2 ">
                <div class="col-2 plant-name"><small>@plant.GetPlantName()</small></div>
                <div class="col-10 plant-calendar">
                    <div class="row flex-nowrap year g-0 border-b" id="@plant.GetPlantName()-year">
                        @for (int month = 1; month < 13; month++)
                        {

                            <div class="col month pe-1" id="@plant.GetPlantName()-month-@month">
                                <div class="row flex-nowrap weeks g-0">
                                    @for (int week = 1; week <= GetNumberOfMondays(month); week++)
                                    {
                                        <div class="col week @GetTaskClass(month, week, plant)" id="@plant.GetPlantName()-@week"><span>&nbsp;</span></div>
                                    }
                                </div>
                            </div>

                        }
                    </div>
                </div>
            </div>
        }
        <br />
        <div class="row flex-nowrap">

            <div class="col-1">Tomato</div>

            <div class="col-11">
                <div class="row flex-nowrap months g-0">
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary">
                                <span>&nbsp</span>
                            </div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork "></div>
                            <div class="col week nowork  border-danger border-end border-5"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork "></div>
                            <div class="col week nowork   border-danger border-end border-5"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week bg-warning"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-warning"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"><span>&nbsp</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row flex-nowrap">

            <div class="col-1">Pepper</div>

            <div class="col-11">
                <div class="row flex-nowrap months g-0">
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary">
                                <span>&nbsp</span>
                            </div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-secondary"></div>
                            <div class="col week bg-secondary"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork "></div>
                            <div class="col week nowork  border-danger border-end border-5"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week nowork "></div>
                            <div class="col week nowork   border-danger border-end border-5"></div>
                            <div class="col week nowork"></div>
                            <div class="col week nowork"></div>
                            <div class="col week bg-warning"><span>&nbsp</span></div>
                        </div>
                    </div>
                    <div class="col month pe-1">
                        <div class="row flex-nowrap months g-0">
                            <div class="col week bg-warning"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"></div>
                            <div class="col week bg-primary"><span>&nbsp</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    }
</div>

@code {
    HarvestCycleModel? _harvest;
    List<PlantScheduleModel>? _plants;
    Dictionary<int, int> _mondaysPerMonth = new();
    GardenModel? _garden;

    public async void Initialize(HarvestCycleModel harvest)
    {
        _harvest = harvest;
        //_plants = await _harvestService.GetPlantHarvests(_harvest.HarvestCycleId, false);

        _garden = await _gardenService.GetGarden(_harvest.GardenId, true);

        _plants = new();
        _plants.Add(new PlantScheduleModel()
            {
                PlantName = "Tomato",
                PlantVarietyName = "Big Red",
                PlantCalendar = new List<PlantSchedule>(){
                        new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("02/10/2023"),
                            EndDate = DateTime.Parse("02/24/2023"),
                            Task = WorkLogReasonEnum.SowIndoors
                        },
                         new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("06/01/2023"),
                            EndDate = DateTime.Parse("06/01/2023"),
                            Task = WorkLogReasonEnum.TransplantOutside
                        },
                         new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("08/15/2023"),
                            EndDate = DateTime.Parse("09/18/2023"),
                            Task = WorkLogReasonEnum.Harvest
                        }
                }
            });
        _plants.Add(new PlantScheduleModel()
            {
                PlantName = "Pepper",
                PlantVarietyName = "Summer Bell",
                PlantCalendar = new List<PlantSchedule>(){
                        new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("04/01/2023"),
                            EndDate = DateTime.Parse("04/01/2023"),
                            Task = WorkLogReasonEnum.SowIndoors
                        },
                         new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("06/15/2023"),
                            EndDate = DateTime.Parse("06/15/2023"),
                            Task = WorkLogReasonEnum.TransplantOutside
                        },
                         new PlantSchedule()
                        {
                            StartDate = DateTime.Parse("08/15/2023"),
                            EndDate = DateTime.Parse("09/18/2023"),
                            Task = WorkLogReasonEnum.Harvest
                        }
                }
            });
        StateHasChanged();
    }

    private int GetNumberOfMondays(int month)
    {
        int numberOfMondays = 0;

        if (!_mondaysPerMonth.TryGetValue(month, out numberOfMondays))
        {
            int year = DateTime.Now.Year;


            for (int day = 1; day <= DateTime.DaysInMonth(year, month); day++)
            {
                if (new DateTime(year, month, day).DayOfWeek == DayOfWeek.Monday)
                {
                    numberOfMondays++;
                }
            }
            if (month != 12)
            {
                DateTime nextMonth = new DateTime(year, month + 1, 1);
                if (nextMonth.DayOfWeek == DayOfWeek.Sunday || nextMonth.DayOfWeek == DayOfWeek.Monday)
                {
                    numberOfMondays++;
                }
            }

            _mondaysPerMonth.Add(month, numberOfMondays);
            Console.WriteLine($"There is {numberOfMondays} Mondays in {month}");
        }
        return numberOfMondays;
    }

    private string GetTaskClass(int month, int week, PlantScheduleModel plant)
    {
        string taskClass = "nowork";

        int year = DateTime.Now.Year;
        DateTime firstDayOfMonth = new DateTime(year, month, 1);

        int firstDayOfWeek = (int)firstDayOfMonth.DayOfWeek;

        int dayOfWeek = 1;

        DateTime targetDate = firstDayOfMonth.AddDays((week - 1) * 7 + dayOfWeek - firstDayOfWeek);
        DateTime targetDateEnd = targetDate.AddDays(7);

        Console.WriteLine($"Considering date - {targetDate} to {targetDateEnd}");
        var schedule = plant.PlantCalendar.FirstOrDefault(p => (targetDate <= p.StartDate && p.StartDate <= targetDateEnd)
                                                                    || (p.StartDate <= targetDate && targetDateEnd <= p.EndDate)
                                                                    || (targetDate <= p.EndDate && p.EndDate <= targetDateEnd)
                                                            );

        if (schedule != null)
        {
            Console.WriteLine($"Found match - {schedule}");
            switch (schedule.Task)
            {
                case WorkLogReasonEnum.SowIndoors:
                    taskClass= "sow-indoors";
                    break;
                case WorkLogReasonEnum.TransplantOutside:
                    taskClass= "transplant";
                    break;
                case WorkLogReasonEnum.Harvest:
                    taskClass= "harvest";
                    break;
            }
        }

        if ((targetDate <= _garden.LastFrostDate && _garden.LastFrostDate <= targetDateEnd)
           || targetDate <= _garden.FirstFrostDate && _garden.FirstFrostDate <= targetDateEnd
       )
        {
            return taskClass + " border-end border-danger border-5";
        }

        return taskClass;
    }

}
